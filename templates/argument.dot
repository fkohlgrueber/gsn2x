{#- TODO Too much is shown here. Only show what? Elements defined, yes. Elements in other modules? #}
{% import "macros.dot" as macros %}


digraph "{{module}}" {
  graph [class="gsndiagram", ranksep="equally", newrank="true"{%- if stylesheet %}, stylesheet="{{ stylesheet }}"{%- endif %}]

  ## Elements
  {%- for id, node in nodes %}
  "{{id}}" [{{- macros::render_box(id=id, node=node) -}}];
  {%- if id is starting_with("A") %}
  "{{id}}":e -> "{{id}}":e [headlabel=< <B>A</B> >, labeldistance=2.5, penwidth=0, arrowhead=none]; 
  {%- elif id is starting_with("J") %}
  "{{id}}":e -> "{{id}}":e [headlabel=< <B>J</B> >, labeldistance=2.5, penwidth=0, arrowhead=none]; 
  {%- endif %}
  {%- if node["undeveloped"] and node["undeveloped"] == true %}
  "{{id}}":s -> "{{id}}":s [taillabel=<<br/><b>&#9826;</b>>,color=transparent,arrowhead=none,labeldistance=0.1]
  {%- endif %}
  {%- endfor %}

  ## Relations
  {%- for id, node in nodes %}
      {%- if node.supportedBy is iterable %} 
        {%- for target in node["supportedBy"] %}
  "{{id}}" -> "{{target}}" [class="gsnedge gsnspby"];
        {%- endfor %} 
      {%- endif %} 

    {%- if node.inContextOf is iterable %}
  subgraph cluster{{loop.index}} {
    graph[peripheries=0];
    {
      rank = same; 
      {%- for c in node.inContextOf %}
        {%- if loop.index is odd %}
      "{{id}}" -> "{{c}}" [arrowhead=empty, class="gsnedge gsninctxt"]; 
        {%- else %}
      "{{c}}" -> "{{id}}" [dir=back, arrowtail=empty, class="gsnedge gsninctxt"]; 
        {%- endif %}
      {%- endfor %}
    }
  }
    {%- endif %} 
  {%- endfor %}

  {% set levlen = levels | length %}
  {% if levlen > 0 %}
  ## Ranks (Levels)
    {%- for level in levels %}
  {rank=same; {%- for id, node in nodes %} {%- if node.level == level %} {{id}};{%- if node.inContextOf is iterable %}{% for ic in node.inContextOf %} {{ic}};{%- endfor %}{%- endif %}{%- endif %}{%- endfor %}}
    {%- endfor %}
  {%- endif %}
}

